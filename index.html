<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三美女遊香港-行程 Web App (修改版)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--color-blue:#4169E1;--color-red:#D93025;--color-bg-ext:#F5F7F8}
    .bg-royal-blue{background-color:var(--color-blue)}.text-royal-blue{color:var(--color-blue)}.bg-deep-red{background-color:var(--color-red)}.text-deep-red{color:var(--color-red)}.bg-extension{background-color:var(--color-bg-ext)}
    .hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}.hide-scrollbar::-webkit-scrollbar{display:none}
    .ticket-card{background-color:white;position:relative}
    .ticket-card::after{content:"";position:absolute;bottom:40px;left:0;right:0;height:1px;background-image:linear-gradient(to right,#ccc 50%,transparent 50%);background-size:15px 1px;background-repeat:repeat-x}
    .ticket-cutout-left,.ticket-cutout-right{position:absolute;bottom:35px;width:20px;height:20px;background-color:white;border-radius:50%;z-index:10}
    .ticket-cutout-left{left:-10px}.ticket-cutout-right{right:-10px}

    /* swipe list styles */
    .swipe-item{position:relative;overflow:hidden}
    .swipe-content{transition:transform 0.25s ease;background:white}
    .swipe-actions{position:absolute;top:0;right:0;height:100%;display:flex;align-items:center;gap:8px;padding:0 8px}
    .swipe-delete{background:#ef4444;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .swipe-confirm{background:#f97316;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}

    /* small helper */
    .day-select, .time-select{appearance:none}
  </style>
</head>
<body class="bg-extension min-h-screen">
<div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen">
  <header class="relative">
    <div class="h-[200px] overflow-hidden relative bg-extension">
      <div class="w-full h-full object-cover absolute top-0 bg-gray-200 flex items-center justify-center text-gray-400">Banner Image</div>
    </div>
    <div class="absolute top-0 left-0 right-0 z-20 flex justify-between items-center p-4">
      <button @click="toggleEditMode" :class="isEditMode? 'bg-deep-red text-white':'bg-white/90 text-gray-700'" class="p-2 rounded-full transition duration-300 shadow-md flex items-center text-sm">
        <i :class="isEditMode? 'fas fa-pen-nib':'fas fa-eye'" class="mr-1"></i>
        {{ isEditMode ? '編輯中' : '瀏覽模式' }}
      </button>
      <button @click="isMenuOpen = !isMenuOpen" class="p-3 rounded-xl bg-white/90 text-gray-700 shadow-md hover:bg-white transition duration-300">
        <i class="fas fa-bars fa-lg"></i>
      </button>
    </div>
  </header>

  <!-- Right menu drawer -->
  <transition name="fade">
    <div v-if="isMenuOpen" class="fixed inset-0 z-40">
      <div @click="isMenuOpen = false" class="absolute inset-0 bg-black opacity-40"></div>
      <div class="absolute top-0 right-0 w-64 bg-white h-full shadow-2xl p-6">
        <h3 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">功能選單</h3>
        <ul class="space-y-4">
          <li v-for="menu in orderedMenus" :key="menu.tab" @click="setActiveTab(menu.tab)" :class="activeTab===menu.tab? 'bg-deep-red text-white shadow-md':'text-gray-700 hover:bg-gray-100'" class="p-3 rounded-lg flex items-center cursor-pointer transition duration-200">
            <i :class="menu.icon" class="w-5 mr-3"></i>
            <span>{{ menu.name }}</span>
          </li>
        </ul>
      </div>
    </div>
  </transition>

  <main class="-mt-8 pt-8 relative z-0">
    <section v-if="activeTab==='itinerary'" class="p-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">每日行程表</h2>
      <div class="flex overflow-x-scroll space-x-4 pb-4 px-4 hide-scrollbar">
        <div v-for="day in itineraryData" :key="day.date" @click="activeDate=day.date" :class="activeDate===day.date? 'bg-royal-blue text-white':'bg-white border'" class="flex-shrink-0 w-16 h-16 flex flex-col items-center justify-center rounded-xl p-1 cursor-pointer">
          <span class="text-sm">{{ day.dayOfWeek }}</span>
          <span class="text-xl font-bold">{{ day.date.split('/')[2] }}</span>
        </div>
      </div>

      <div class="p-2">
        <button v-if="isEditMode" @click="openAddModal(activeDate)" class="w-full bg-green-100 text-green-700 p-3 rounded-xl mb-4">新增景點/美食/活動</button>
        <div v-for="day in itineraryData" :key="day.date" v-show="activeDate===day.date">
          <div class="space-y-3">
            <div v-for="(item, index) in day.items" :key="item.id" class="swipe-item rounded-xl shadow-lg" :class="{'opacity-70': item.category==='航班'}" @click="onItemClick(item, day.date)" @mousedown="onPointerStart($event, item, day.date, index)" @mousemove="onPointerMove($event, item, day.date, index)" @mouseup="onPointerEnd($event, item, day.date, index)" @touchstart.passive="onTouchStart($event, item, day.date, index)" @touchmove.passive="onTouchMove($event, item, day.date, index)" @touchend.passive="onTouchEnd($event, item, day.date, index)">

              <div class="swipe-content p-4 bg-white rounded-xl border-l-4" :style="{'border-left-color': getLeftColor(item)}" :ref="el => item._el = el">
                <div v-if="item.category==='航班'" class="bg-gray-100 p-3 rounded-lg ticket-card">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-700"><i class="fas fa-plane-departure mr-1"></i> 航班</span>
                    <span class="text-xl font-mono font-bold text-deep-red">{{ item.flightNumber }}</span>
                  </div>
                  <div class="grid grid-cols-3 gap-2 text-sm text-gray-700">
                    <div>
                      <p class="font-bold text-lg">{{ item.startTime }}</p>
                      <p class="text-xs text-gray-500">{{ item.fromAirport.split(' ')[0] }}</p>
                    </div>
                    <div class="text-center"><i class="fas fa-arrow-right text-royal-blue"></i><p class="text-xs text-gray-500">{{ item.duration }}</p></div>
                    <div class="text-right"><p class="font-bold text-lg">{{ item.endTime }}</p><p class="text-xs text-gray-500">{{ item.toAirport.split(' ')[0] }}</p></div>
                  </div>
                </div>

                <div v-else>
                  <div class="flex justify-between items-start">
                    <div>
                      <span class="text-xs font-semibold px-2 py-0.5 rounded-full" :class="getCategoryClasses(item.category)">{{ item.category }}</span>
                      <h3 class="text-lg font-bold mt-1 text-gray-800">{{ item.name }}</h3>
                    </div>
                    <button @click.stop="openGoogleMaps(item.location)" title="導航" class="text-royal-blue hover:text-deep-red p-2"><i class="fas fa-route"></i></button>
                  </div>
                  <div class="mt-2 text-sm text-gray-700 space-y-1">
                    <p><i class="far fa-clock mr-1 text-royal-blue"></i><strong>{{ item.startTime }}</strong> - <strong>{{ item.endTime }}</strong> <span class="text-xs text-gray-500 ml-1">(停留{{ item.duration }})</span></p>
                    <p v-if="item.businessHoursDisplay"><i class="fas fa-info-circle mr-1"></i>營業時間: {{ item.businessHoursDisplay }}</p>
                    <p v-if="item.address"><i class="fas fa-map-marker-alt mr-1"></i>地址: {{ item.address }}</p>
                    <p v-if="item.ticket"><i class="fas fa-ticket-alt mr-1"></i>門票: {{ item.ticket }}</p>
                    <p v-if="item.notes"><i class="fas fa-comment-dots mr-1"></i>筆記: {{ item.notes }}</p>
                  </div>
                </div>
              </div>

              <!-- actions revealed on swipe -->
              <div class="swipe-actions" style="right:8px">
                <div class="swipe-delete" @click.stop="onSwipeDelete(item, day.date, index)">刪除</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section v-else-if="activeTab==='info'" class="p-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">旅行資訊</h2>
      <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-royal-blue">
        <h3 class="font-bold text-lg mb-2 text-royal-blue"><i class="fas fa-coins mr-1"></i>匯率換算 (HKD 兌 TWD)</h3>
        <p class="text-sm text-gray-500 mb-3">模擬即時匯率: HKD1 ≈ TWD {{ exchangeRate.toFixed(2) }}</p>
      </div>
      <div class="bg-white p-4 rounded-xl mb-6 shadow-md border-t-4 border-deep-red">
        <h3 class="font-bold text-lg mb-2 text-deep-red"><i class="fas fa-plane mr-2"></i>航班資訊</h3>
        <div v-for="(flight, type) in flightInfo" :key="type" class="mb-4 pb-2 border-b last:border-b-0">
          <p class="font-semibold text-gray-700">{{ type==='to'? '去程':'回程' }}</p>
          <div class="text-sm grid grid-cols-2 gap-x-4">
            <p>航線: <span class="font-mono">{{ flight.from }} - {{ flight.to }}</span></p>
            <p>航班: <span class="font-mono">{{ flight.number }}</span></p>
            <p>起飛: <strong>{{ flight.depTime }}</strong></p>
            <p>抵達: <strong>{{ flight.arrTime }}</strong></p>
            <p class="col-span-2">飛行時間: {{ flight.duration }} / 機型: {{ flight.model }}</p>
          </div>
        </div>
      </div>
    </section>

    <section v-else-if="activeTab==='shopping'" class="p-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">購物清單</h2>
      <button v-if="isEditMode" @click="openAddItemModal('shopping')" class="w-full bg-green-100 text-green-700 p-3 rounded-xl mb-4">新增購物項目</button>
      <div class="space-y-4">
        <div v-for="(item, index) in shoppingList" :key="item.id" class="swipe-item p-4 rounded-xl shadow-md border-l-4" :style="{'border-left-color':'#4169E1'}" @click="onItemClick(item)" @touchstart.passive="onTouchStart($event,item,null,index)" @touchmove.passive="onTouchMove($event,item,null,index)" @touchend.passive="onTouchEnd($event,item,null,index)">
          <div class="swipe-content flex items-center">
            <div class="w-16 h-16 bg-gray-100 rounded-lg mr-4 flex items-center justify-center overflow-hidden"><i class="fas fa-camera text-gray-400 text-xl"></i></div>
            <div class="flex-grow">
              <p class="font-bold text-gray-800">{{ item.name }}</p>
              <p class="text-xs font-semibold text-deep-red">{{ item.category }}</p>
              <p v-if="item.notes" class="text-sm text-gray-500">備註: {{ item.notes }}</p>
            </div>
          </div>
          <div class="swipe-actions" style="right:8px"><div class="swipe-delete" @click.stop="onSwipeDelete(item,null,index)">刪除</div></div>
        </div>
      </div>
    </section>

    <section v-else-if="activeTab==='expense'" class="p-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-deep-red pl-2">花費記錄</h2>
      <div class="bg-royal-blue text-white p-4 rounded-xl mb-4 shadow-lg text-center">
        <p class="text-sm font-semibold">總花費 (TWD)</p>
        <p class="text-4xl font-bold">{{ totalExpenseTWD.toLocaleString(undefined,{maximumFractionDigits:0}) }}</p>
      </div>
      <button v-if="isEditMode" @click="openAddItemModal('expense')" class="w-full bg-green-100 text-green-700 p-3 rounded-xl mb-4">新增開銷</button>
      <div class="space-y-3">
        <div v-for="(item,index) in expenses" :key="item.id" class="swipe-item bg-white p-3 rounded-xl shadow-sm border-l-4" :style="{'border-left-color': item.paymentMethod==='現金'? '#10B981':'#3B82F6'}" @click="onItemClick(item)" @touchstart.passive="onTouchStart($event,item,null,index)" @touchmove.passive="onTouchMove($event,item,null,index)" @touchend.passive="onTouchEnd($event,item,null,index)">
          <div class="swipe-content flex justify-between items-center">
            <div class="flex-grow">
              <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">{{ item.category }}</span>
              <p class="font-bold text-gray-800 mt-1">{{ item.name }}</p>
              <p class="text-xs text-gray-500">{{ item.date }} | {{ item.paymentMethod }} <span v-if="item.payer" class="ml-2 font-semibold text-deep-red">({{ item.payer }})</span></p>
            </div>
            <div class="text-right"><p class="text-xl font-bold text-deep-red">{{ item.amount.toLocaleString() }} {{ item.currency }}</p><p class="text-xs text-gray-500">≈ {{ item.amountTWD.toLocaleString(undefined,{maximumFractionDigits:0}) }} TWD</p></div>
          </div>
          <div class="swipe-actions" style="right:8px"><div class="swipe-delete" @click.stop="onSwipeDelete(item,null,index)">刪除</div></div>
        </div>
      </div>
    </section>

  </main>

  <!-- Modal -->
  <transition name="fade">
    <div v-if="isModalOpen && currentItem" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4">{{ modalTitle }}</h3>
        <form @submit.prevent="saveItem" class="space-y-4">
          <template v-if="modalType==='itinerary'">
            <div class="text-sm text-gray-600">日期: {{ currentItemDate }}</div>
            <div>
              <label class="block text-sm font-semibold mb-1">名稱/標題</label>
              <input type="text" v-model="currentItem.name" required class="w-full p-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">分類</label>
              <select v-model="currentItem.category" class="w-full p-2 border rounded-md">
                <option v-for="cat in categories.filter(c=>c!=='航班')" :key="cat" :value="cat">{{ cat }}</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">地址</label>
              <input type="text" v-model="currentItem.address" placeholder="例如: 尖沙咀彌敦道" class="w-full p-2 border rounded-md">
            </div>

            <!-- Business hours structured inputs -->
            <div>
              <label class="block text-sm font-semibold mb-1">營業時間</label>
              <div class="grid grid-cols-3 gap-2">
                <div>
                  <select v-model="currentItem.businessStartDay" class="w-full p-2 border rounded-md day-select">
                    <option v-for="d in weekDays" :key="d" :value="d">{{ d }}</option>
                  </select>
                </div>
                <div>
                  <select v-model="currentItem.businessEndDay" class="w-full p-2 border rounded-md day-select">
                    <option v-for="d in weekDays" :key="d" :value="d">{{ d }}</option>
                  </select>
                </div>
                <div class="text-sm text-gray-500 flex items-center">(起訖 星期)</div>
              </div>

              <div class="grid grid-cols-4 gap-2 mt-2">
                <select v-model="currentItem.businessStartHour" class="w-full p-2 border rounded-md time-select" v-for="i in 1" :key="'sh'">
                  <option v-for="h in hours" :key="h" :value="h">{{ h }}</option>
                </select>
                <select v-model="currentItem.businessStartMinute" class="w-full p-2 border rounded-md time-select">
                  <option v-for="m in minutes" :key="m" :value="m">{{ m }}</option>
                </select>
                <select v-model="currentItem.businessEndHour" class="w-full p-2 border rounded-md time-select">
                  <option v-for="h in hours" :key="h+'e'" :value="h">{{ h }}</option>
                </select>
                <select v-model="currentItem.businessEndMinute" class="w-full p-2 border rounded-md time-select">
                  <option v-for="m in minutes" :key="m+'e'" :value="m">{{ m }}</option>
                </select>
              </div>
              <p class="text-xs text-gray-500 mt-1">顯示格式：Mon-Sat (09:00-21:00)</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold mb-1">停留時間</label>
                <input type="text" v-model="currentItem.duration" placeholder="例如: 2h30m" class="w-full p-2 border rounded-md">
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">開始時間</label>
                <input type="time" v-model="currentItem.startTime" class="w-full p-2 border rounded-md">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1">門票/費用</label>
              <input type="text" v-model="currentItem.ticket" class="w-full p-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">個人筆記/提醒</label>
              <textarea v-model="currentItem.notes" rows="2" class="w-full p-2 border rounded-md"></textarea>
            </div>

          </template>

          <template v-else-if="modalType==='shopping'">
            <div><label class="block text-sm font-semibold mb-1">商品名稱</label><input type="text" v-model="currentItem.name" class="w-full p-2 border rounded-md"></div>
            <div><label class="block text-sm font-semibold mb-1">分類</label><select v-model="currentItem.category" class="w-full p-2 border rounded-md"><option>伴手禮</option><option>紀念品</option><option>其他</option></select></div>
            <div><label class="block text-sm font-semibold mb-1">備註/地點</label><input type="text" v-model="currentItem.notes" class="w-full p-2 border rounded-md"></div>
          </template>

          <template v-else-if="modalType==='expense'">
            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold mb-1">日期</label><input type="text" v-model="currentItem.date" class="w-full p-2 border rounded-md"></div><div><label class="block text-sm font-semibold mb-1">項目名稱</label><input type="text" v-model="currentItem.name" class="w-full p-2 border rounded-md"></div></div>
            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold mb-1">分類</label><select v-model="currentItem.category" class="w-full p-2 border rounded-md"><option>飲食</option><option>交通</option><option>購物</option><option>門票</option><option>住宿</option><option>其他</option></select></div><div><label class="block text-sm font-semibold mb-1">金額</label><input type="number" v-model.number="currentItem.amount" class="w-full p-2 border rounded-md"></div></div>
            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold mb-1">貨幣</label><select v-model="currentItem.currency" class="w-full p-2 border rounded-md"><option>HKD</option><option>TWD</option></select></div><div><label class="block text-sm font-semibold mb-1">付款人</label><select v-model="currentItem.payer" class="w-full p-2 border rounded-md"><option v-for="p in payers" :key="p">{{ p }}</option></select></div></div>
          </template>

          <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
            <button type="button" @click="closeModal" class="px-4 py-2 bg-gray-200 rounded-lg">取消</button>
            <button type="submit" class="px-4 py-2 bg-royal-blue text-white rounded-lg font-semibold">{{ isEditModalMode? '儲存變更':'新增項目' }}</button>
          </div>
        </form>
      </div>
    </div>
  </transition>

</div>

<script>
const { createApp, ref, computed, watch, nextTick } = Vue;

createApp({
  setup(){
    const isEditMode = ref(false);
    const isMenuOpen = ref(false);
    const activeTab = ref('itinerary');
    const activeDate = ref('2026/3/6');
    const isModalOpen = ref(false);
    const isEditModalMode = ref(false);
    const modalTitle = ref('');
    const modalType = ref('');
    const currentItem = ref(null);
    const currentItemDate = ref('');

    const weekDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const hours = Array.from({length:24},(v,i)=>String(i).padStart(2,'0'));
    const minutes = ['00','15','30','45'];

    const categories = ['景點','住宿','美食','購物','交通','其他'];
    const payers = ['沛晴','芳晨','玟妤'];

    // initial data (shortened)
    const itineraryData = ref([
      {date:'2026/3/6', dayOfWeek:'FRI', items:[{id:1,category:'航班',name:'去程航班',flightNumber:'JX233',fromAirport:'TPE T2',toAirport:'HKG T1',startTime:'08:00',endTime:'10:10',duration:'2h10m',airline:'星宇航空',notes:'登機前兩小時抵達機場',location:'香港國際機場'}]} ,
      {date:'2026/3/7', dayOfWeek:'SAT', items:[]}
    ]);

    const flightInfo = ref({to:{from:'TPE',to:'HKG',number:'JX233',depTime:'08:00',arrTime:'10:10',duration:'2h10m',model:'A321neo'}});
    const shoppingList = ref([]);
    const expenses = ref([]);

    // menus with expense last
    const menus = [
      {tab:'itinerary',name:'每日行程',icon:'fas fa-calendar-alt'},
      {tab:'info',name:'旅行資訊',icon:'fas fa-info-circle'},
      {tab:'shopping',name:'購物清單',icon:'fas fa-shopping-basket'},
      {tab:'food',name:'美食清單',icon:'fas fa-utensils'},
      {tab:'expense',name:'花費記錄',icon:'fas fa-hand-holding-usd'}
    ];

    const orderedMenus = computed(()=>{
      // ensure expense at bottom
      const copy = [...menus];
      const idx = copy.findIndex(m=>m.tab==='expense');
      if(idx!==-1){ const e=copy.splice(idx,1)[0]; copy.push(e);} return copy;
    });

    const exchangeRate = ref(4.00);
    const foreignAmount = ref(100);

    // Helpers
    const toggleEditMode = ()=>{ isEditMode.value = !isEditMode.value; };
    const setActiveTab = (tab)=>{ activeTab.value = tab; isMenuOpen.value=false; };

    const openGoogleMaps = (loc)=>{ if(!loc) return; window.open('https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(loc),'_blank'); };

    const openAddModal = (date)=>{
      isEditModalMode.value = false; modalType.value='itinerary'; modalTitle.value='新增行程項目'; currentItem.value = { id:Date.now(), name:'', category:'景點', duration:'1h0m', startTime:'09:00', endTime:'', ticket:'', notes:'', location:'', address:'', businessStartDay:'Mon', businessEndDay:'Sat', businessStartHour:'09', businessStartMinute:'00', businessEndHour:'21', businessEndMinute:'00' };
      currentItemDate.value = date; isModalOpen.value = true;
    };

    const openEditModal = (item,date)=>{
      isEditModalMode.value = true; modalType.value='itinerary'; modalTitle.value='編輯: '+item.name; currentItem.value = JSON.parse(JSON.stringify(item));
      // ensure business fields exist
      currentItem.value.businessStartDay = currentItem.value.businessStartDay || 'Mon';
      currentItem.value.businessEndDay = currentItem.value.businessEndDay || 'Sat';
      currentItem.value.businessStartHour = currentItem.value.businessStartHour || '09';
      currentItem.value.businessStartMinute = currentItem.value.businessStartMinute || '00';
      currentItem.value.businessEndHour = currentItem.value.businessEndHour || '21';
      currentItem.value.businessEndMinute = currentItem.value.businessEndMinute || '00';
      currentItemDate.value = date; isModalOpen.value = true;
    };

    const onItemClick = (item,date)=>{
      if(isEditMode.value){ openEditModal(item,date); }
    };

    const saveItem = ()=>{
      if(modalType.value==='itinerary'){
        const day = itineraryData.value.find(d=>d.date===currentItemDate.value);
        // prepare business display
        currentItem.value.businessHoursDisplay = `${currentItem.value.businessStartDay}-${currentItem.value.businessEndDay} (${currentItem.value.businessStartHour}:${currentItem.value.businessStartMinute}-${currentItem.value.businessEndHour}:${currentItem.value.businessEndMinute})`;
        if(isEditModalMode.value){
          const idx = day.items.findIndex(i=>i.id===currentItem.value.id); if(idx!==-1) day.items.splice(idx,1,currentItem.value);
        } else { day.items.push(currentItem.value); }
      } else if(modalType.value==='shopping'){
        if(isEditModalMode.value){ const idx = shoppingList.value.findIndex(i=>i.id===currentItem.value.id); if(idx!==-1) shoppingList.value[idx]=currentItem.value; } else shoppingList.value.push(currentItem.value);
      } else if(modalType.value==='expense'){
        if(currentItem.value.currency==='HKD'){ currentItem.value.amountTWD = currentItem.value.amount * exchangeRate.value; } else currentItem.value.amountTWD = currentItem.value.amount;
        if(isEditModalMode.value){ const idx = expenses.value.findIndex(i=>i.id===currentItem.value.id); if(idx!==-1) expenses.value[idx]=currentItem.value; } else expenses.value.push(currentItem.value);
      }
      closeModal();
    };

    const closeModal = ()=>{ isModalOpen.value=false; currentItem.value=null; isEditModalMode.value=false; };

    const deleteItemConfirmed = (list, idx)=>{ if(confirm('確定要刪除此項目嗎?')){ list.splice(idx,1); } };

    const onSwipeDelete = (item, day, index)=>{
      if(day){ // itinerary
        const d = itineraryData.value.find(x=>x.date===day); if(!d) return; const idx = index; if(idx===undefined) return; deleteItemConfirmed(d.items, idx);
      } else {
        // shopping or expenses: determine which list contains item
        const sIdx = shoppingList.value.findIndex(i=>i.id===item.id); if(sIdx!==-1){ deleteItemConfirmed(shoppingList.value,sIdx); return; }
        const eIdx = expenses.value.findIndex(i=>i.id===item.id); if(eIdx!==-1){ deleteItemConfirmed(expenses.value,eIdx); return; }
      }
    };

    // swipe handling (simple): track touch/mouse horizontal move to translate content
    const pointerState = {startX:0, currentX:0, active:null};

    const onTouchStart = (e,item,day,index)=>{ pointerState.startX = e.touches[0].clientX; pointerState.currentX = pointerState.startX; pointerState.active = {item,day,index}; if(item && item._el) item._el.style.transition='none'; };
    const onTouchMove = (e,item,day,index)=>{ if(!pointerState.active) return; pointerState.currentX = e.touches[0].clientX; const dx = pointerState.currentX - pointerState.startX; if(dx<0){ const translate = Math.max(dx, -120); if(item && item._el) item._el.style.transform = `translateX(${translate}px)`; } };
    const onTouchEnd = (e,item,day,index)=>{ if(!pointerState.active) return; const dx = pointerState.currentX - pointerState.startX; if(item && item._el){ item._el.style.transition='transform 0.25s'; if(dx<-50){ item._el.style.transform='translateX(-100px)'; } else item._el.style.transform='translateX(0)'; }
      pointerState.active=null; pointerState.startX=0; pointerState.currentX=0; };

    // mouse equivalents
    const onPointerStart = (e,item,day,index)=>{ if(e.button!==0) return; pointerState.startX = e.clientX; pointerState.currentX = e.clientX; pointerState.active={item,day,index}; if(item && item._el) item._el.style.transition='none'; };
    const onPointerMove = (e,item,day,index)=>{ if(!pointerState.active) return; pointerState.currentX = e.clientX; const dx = pointerState.currentX - pointerState.startX; if(dx<0){ const translate = Math.max(dx, -120); if(item && item._el) item._el.style.transform = `translateX(${translate}px)`; } };
    const onPointerEnd = (e,item,day,index)=>{ if(!pointerState.active) return; const dx = pointerState.currentX - pointerState.startX; if(item && item._el){ item._el.style.transition='transform 0.25s'; if(dx<-50){ item._el.style.transform='translateX(-100px)'; } else item._el.style.transform='translateX(0)'; }
      pointerState.active=null; pointerState.startX=0; pointerState.currentX=0; };

    const getLeftColor = (item)=>{ if(item.category==='航班') return '#9CA3AF'; if(item.category==='住宿') return '#4169E1'; return '#D93025'; };
    const getCategoryClasses = (category)=>{ if(category==='住宿') return 'bg-royal-blue/10 text-royal-blue'; if(category==='美食') return 'bg-yellow-100 text-yellow-700'; if(category==='購物') return 'bg-purple-100 text-purple-700'; if(category==='交通') return 'bg-gray-100 text-gray-700'; return 'bg-deep-red/10 text-deep-red'; };

    const totalExpenseTWD = computed(()=> expenses.value.reduce((s,i)=> s + (i.amountTWD||0),0));

    return { isEditMode, toggleEditMode, isMenuOpen, orderedMenus, setActiveTab, activeTab, activeDate, itineraryData, flightInfo, shoppingList, expenses, exchangeRate, foreignAmount, openAddModal, openEditModal, isModalOpen, currentItem, modalTitle, modalType, saveItem, closeModal, isEditModalMode, categories, payers, openAddItemModal: (t)=>{ modalType.value=t; isModalOpen.value=true; isEditModalMode.value=false; currentItem.value={id:Date.now(),name:'',category:'伴手禮',notes:''}; modalTitle.value='新增'; }, onItemClick, onTouchStart, onTouchMove, onTouchEnd, onPointerStart, onPointerMove, onPointerEnd, onSwipeDelete, weekDays, hours, minutes, getCategoryClasses, getLeftColor, totalExpenseTWD, shoppingList, modalTitle, currentItemDate, currentItem, isEditModalMode
  }
}).mount('#app');
</script>
</body>
</html>
